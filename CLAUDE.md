# CLAUDE.md - Coding Assistant Guidelines

## Build & Development Commands
- `yarn dev`: Run local development server
- `yarn build`: Build the production site
- `yarn start`: Start the production server

### Dev Server for Agents
Do **not** try to start the Next.js dev server (`yarn dev`) in the background — the bash tool kills background processes. If you need a running dev server for verification:
1. Ask the user to start it.
2. Assume it's running on `localhost:3000` if the user says so.
3. For one-shot checks, use `npx next build` or static analysis instead.

## Code Style Guidelines
- **Components**: Use functional React components with hooks
- **Naming**: PascalCase for components, camelCase for functions/variables
- **Imports**: React/Next.js first, third-party libs next, local imports last
- **CSS**: Use Tailwind utility classes for styling
- **Error Handling**: Use try/catch for API calls with specific error responses
- **File Structure**:
  - `/components`: Reusable UI components
  - `/pages`: Next.js pages and API routes 
  - `/public`: Static assets
  - `/styles`: Global CSS

### Testing ESM Scripts
Scripts in `/scripts` use `.mjs` (ESM), but Jest runs in CJS mode via `next/jest`. Do **not** try to import `.mjs` files in tests. Instead:
- Extract testable pure functions into `.js` (CJS) files
- Import those from both the `.mjs` entry point (via `createRequire`) and Jest tests
- Test file naming: `__tests__/<layer>.<module>.test.js` (e.g., `api.subscribe.test.js`)

## Tech Stack
- Next.js with React (JavaScript, not TypeScript)
- Tailwind CSS for styling
- Markdown files for content (in `/content` directory)
- Mailchimp for email subscriptions
- Fathom for analytics

## Next.js Important Lessons

### Static File Generation
For generating static files during build (like RSS feeds):
- Create a script in `/scripts` directory for file generation that uses Node.js modules
- Run this script during build using a package.json pre/post-build command
- Don't mix static file generation with Next.js data fetching methods
- Remember that files need to be written to `/public` to be accessible

### Data Fetching Methods
- Never mix data fetching methods (`getStaticProps`, `getServerSideProps`, `getInitialProps`) in the same file
- For pages that need to return XML/non-HTML content, use `getServerSideProps` with proper content-type headers
- Be cautious with Node.js only modules (fs, path) in browser context

### Date Display
All frontmatter dates (`published_at`, `updated_at`) are stored as UTC midnight (e.g., `"2026-02-11T00:00:00.000Z"`). Any date formatting **must** specify `timeZone: "UTC"` to prevent off-by-one day display in timezones west of UTC. All date formatting goes through `lib/dates.js` — do not introduce new `toLocaleDateString()` or `Intl.DateTimeFormat` calls elsewhere.

## Image Hosting
- `public/content/images/**` is **gitignored** — do not commit images there.
- Essay/blog images must be uploaded to Vercel Blob (see `.pi/skills/vercel-blob-upload/SKILL.md`).
- Blob path convention: `blog/<post-slug>/<filename>`.
- All image references in markdown (body `![]()` + frontmatter `feature_image`, `og_image`, `twitter_image`) must use blob URLs.
- Talk thumbnails go to `public/images/talks/` (committed, not blob-hosted).

## Generated Files (Do Not Hand-Edit)
- `public/sitemap.xml` — generated by `scripts/generate-sitemap.mjs` at build time.
- `public/rss.xml` — generated by `scripts/generate-rss.mjs` at build time.
- `public/notes/` — generated by Quartz (see Quartz Notes Build section).

Changes to these files' content should be made in the generator scripts, not the output files.

## Browser Automation
Use your `web-browser` skill to preview the website

## Quartz Notes Build (Reference)
The notes section (`/public/notes`) is generated by Quartz locally. The Quartz source lives outside this repo, so agents typically:
- Copy notes from Obsidian into Quartz content (flattened): `scripts/copy-online-notes.js`
  - Source: `~/obsidian/v0221/`
  - Destination: `/Users/nnamdi/Programming/quartz/content`
  - The script ensures `index.md` exists for the notes homepage.
- Sync the theme overlay from this repo into a Quartz install: `scripts/sync-quartz-theme.js /path/to/quartz`
- Build Quartz in that repo: `npx quartz build`
- Sync output back into this repo: `rsync -a --delete /path/to/quartz/public/ public/notes/`

The theme overlay files live in `/quartz-theme` and are copied into a clean Quartz install by the sync script. Avoid editing `/public/notes` directly; regenerate via Quartz.

### Notes Route Architecture (Do Not Modify Without Care)
The `/notes` route uses a **middleware → API proxy** architecture, not standard Next.js pages:
- `middleware.js` rewrites `/notes*` requests to `/api/notes-proxy`
- `pages/api/notes-proxy.js` serves Quartz-generated HTML from `public/notes/`
- This is necessary because Next.js client-side routing (via `<Link>`) would otherwise try to resolve `/notes` as a dynamic route through `[slug].js` and fail
- The middleware rewrite, API proxy, and `public/notes/` HTML files are all tightly coupled — do not remove or refactor any piece without testing all five scenarios:
  1. `/notes` redirects to `/notes/`
  2. `/notes/` returns 200 with Quartz HTML
  3. `/notes/subpage` redirects to `/notes/subpage/`
  4. `/notes/subpage/` returns 200
  5. Static assets (CSS/JS) pass through correctly

## Git Commit Guardrails
- Use Conventional Commits for commit subjects: `<type>(<scope>): <summary>`.
- Keep commit summaries imperative, concise, and <= 72 characters.
- If the user specifies file paths/globs, stage and commit **only** those files.
- If there are unrelated or ambiguous changed files, ask for clarification before committing.
- Before committing, review `git status` and `git diff` (or staged diff) to confirm scope.
- Commit only; do **not** push unless explicitly requested.
